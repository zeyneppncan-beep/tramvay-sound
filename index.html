<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tramvay – Hata Ayıklama V3</title>
<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

<style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
    
    /* 3D Model Alanı */
    #viewer { width: 100%; height: 100%; border: none; display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* Başlangıç Ekranı (Siyah Perde) */
    #startScreen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: black;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 999999; /* En üstte olduğundan emin oluyoruz */
    }

    /* KOCAMAN BUTON */
    #btnStart {
        padding: 30px 60px;
        font-size: 25px;
        font-weight: bold;
        background-color: #2ecc71; /* Yeşil */
        color: white;
        border: 4px solid white;
        cursor: pointer;
        border-radius: 10px;
    }
    #btnStart:active { background-color: #27ae60; transform: scale(0.95); }

    /* Bilgi Mesajı */
    #status { color: white; margin-top: 20px; font-family: monospace; }
</style>
</head>
<body>

<div id="startScreen">
    <button id="btnStart">BAŞLAT (TIKLA)</button>
    <div id="status">Sistem hazır, tıklama bekleniyor...</div>
</div>

<iframe src="" id="viewer" allow="autoplay; fullscreen; vr" allowvr allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>

<script>
    // === 1. GLOBAL HATA YAKALAYICI ===
    // Sayfada bir kod hatası olursa hemen ekrana uyarı basar.
    window.onerror = function(message, source, lineno, colno, error) {
        alert("KOD HATASI OLUŞTU:\n" + message + "\nSatır: " + lineno);
    };

    // Değişkenler
    var screen = document.getElementById("startScreen");
    var btn = document.getElementById("btnStart");
    var statusDiv = document.getElementById("status");
    var audioUnlocked = false;
    var sounds = [];

    // === 2. SES DOSYALARI ===
    // Dosya isimleri (Büyük/Küçük harfe dikkat!)
    var fileList = [
        "sounds/trafik.mp3",      // 0
        "sounds/tramvay_ic.mp3",  // 1
        "sounds/tramvay_ray.mp3", // 2
        "sounds/kapi.mp3",        // 3
        "sounds/marti.mp3",       // 4
        "sounds/nefes.mp3"        // 5
    ];

    // Sesleri Yükle
    fileList.forEach(function(src, index) {
        var aud = new Audio(src);
        aud.loop = true;
        aud.volume = 1.0;
        sounds.push(aud);
    });

    // === 3. BUTONA TIKLAMA OLAYI ===
    btn.onclick = function() {
        statusDiv.innerText = "Ses motoru başlatılıyor...";
        
        // Ses kilidini açmayı dene
        if(sounds[0]) {
            sounds[0].play().then(function() {
                // Başarılı olursa:
                sounds[0].pause();
                sounds[0].currentTime = 0;
                audioUnlocked = true;
                
                // Ekranı kaldır
                screen.style.display = "none";
                console.log("Ses sistemi aktif.");
            }).catch(function(err) {
                // Hata olursa:
                alert("SES HATASI: Tarayıcı sesi engelledi veya dosya bulunamadı.\n" + err);
                statusDiv.innerText = "HATA: " + err;
                // Yine de ekranı kapat ki modeli görebilsin
                setTimeout(function(){ screen.style.display = "none"; }, 2000);
            });
        }
    };

    // === 4. SKETCHFAB API ===
    var iframe = document.getElementById( 'viewer' );
    var uid = '35d9707a712d4da1a88d1e4f82da8797';
    var client = new Sketchfab( iframe );

    client.init( uid, {
        success: function( api ) {
            api.start();
            api.addEventListener( 'viewerready', function() {
                console.log( 'Viewer is ready' );

                api.addEventListener( 'annotationFocus', function( index ) {
                    console.log( 'Annotation tıklandı: ', index );
                    
                    if(!audioUnlocked) return;

                    // Tüm sesleri durdur
                    sounds.forEach(function(s){ s.pause(); s.currentTime=0; });

                    // İlgili sesi çal
                    if(sounds[index]) {
                        sounds[index].play().catch(function(e){ console.log(e); });
                    }
                });
            } );
        },
        error: function() {
            alert( 'Sketchfab hatası: Model yüklenemedi.' );
        },
        autostart: 1,
        ui_controls: 1,
        ui_annotations: 1
    } );
</script>

</body>
</html>
