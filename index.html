<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tramvay – Hata Ayıklama Modu</title>
<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
<style>
    html, body { margin: 0; width: 100%; height: 100%; overflow: hidden; background: #333; font-family: sans-serif; }
    #viewer { width: 100%; height: 100%; border: none; }
    
    /* BAŞLAT BUTONU */
    #startSound {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        padding: 20px 40px; font-size: 20px; font-weight: bold;
        background: #e74c3c; color: white; border: 2px solid white;
        border-radius: 8px; cursor: pointer; z-index: 9999;
    }

    /* HATA EKRANI (DEBUGGER) */
    #debugLog {
        position: fixed; top: 0; left: 0; width: 300px; height: auto;
        background: rgba(0,0,0,0.8); color: #00ff00;
        padding: 10px; font-size: 12px; z-index: 10000;
        pointer-events: none; font-family: monospace;
    }
    .error { color: #ff5555; font-weight: bold; }
</style>
</head>
<body>

<div id="debugLog">Sistem Hazırlanıyor...<br></div>
<iframe src="" id="viewer" allow="autoplay; fullscreen; vr" allowvr allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
<button id="startSound">Sesli Deneyimi Başlat</button>

<script>
    // === YARDIMCI: EKRANA LOG YAZMA ===
    function log(msg, isError = false) {
        const d = document.getElementById("debugLog");
        d.innerHTML += (isError ? "<span class='error'>[HATA] " : "[BİLGİ] ") + msg + (isError ? "</span>" : "") + "<br>";
        console.log(msg);
    }

    // === 1. SES DOSYALARI ===
    // Dosya isimlerinizi BURADAN kontrol edin.
    const fileNames = [
        "sounds/trafik.mp3",      // 0
        "sounds/tramvay_ic.mp3",  // 1
        "sounds/tramvay_ray.mp3", // 2
        "sounds/kapi.mp3",        // 3
        "sounds/marti.mp3",       // 4
        "sounds/nefes.mp3"        // 5
    ];

    const sounds = fileNames.map(src => {
        const audio = new Audio(src);
        audio.loop = true;
        audio.volume = 1.0;
        // Dosya yüklenemezse hatayı yakala ve ekrana yaz
        audio.addEventListener('error', function(e) {
            log("Ses dosyası bulunamadı: " + src, true);
        });
        return audio;
    });

    let audioUnlocked = false;
    const btn = document.getElementById("startSound");

    // === 2. KİLİT AÇMA ===
    btn.onclick = () => {
        log("Butona tıklandı. Ses motoru açılıyor...");
        
        // Hata olsa bile butonu gizle ki sistem donmuş gibi görünmesin
        btn.style.display = "none";
        audioUnlocked = true;

        // İlk sesi test amaçlı çalmayı dene
        sounds[0].play().then(() => {
            log("Ses motoru başarıyla çalıştı!");
            sounds[0].pause();
            sounds[0].currentTime = 0;
        }).catch(err => {
            log("Ses oynatma hatası: " + err.message, true);
            log("Lütfen 'sounds' klasörünün adını ve içindeki dosyaları kontrol edin.", true);
        });
    };

    function stopAll() {
        sounds.forEach(s => { s.pause(); s.currentTime = 0; });
    }

    // === 3. SKETCHFAB ===
    const iframe = document.getElementById("viewer");
    const uid = "35d9707a712d4da1a88d1e4f82da8797"; 
    const client = new Sketchfab(iframe);

    client.init(uid, {
        success: function(api) {
            log("Sketchfab yüklendi.");
            api.start();
            api.addEventListener("viewerready", function() {
                log("Model hazır! Numaralara tıklayabilirsiniz.");

                api.addEventListener("annotationFocus", function(index) {
                    log("Tıklanan Annotation No: " + index);

                    if (!audioUnlocked) {
                        log("Önce 'Sesli Deneyimi Başlat' butonuna basmalısınız!", true);
                        return;
                    }

                    stopAll();
                    if (sounds[index]) {
                        log("Çalınıyor: " + fileNames[index]);
                        var playPromise = sounds[index].play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                log("Oynatılamadı: " + error, true);
                            });
                        }
                    } else {
                        log("Bu numara için listede ses yok.", true);
                    }
                });
            });
        },
        error: function() { log("Sketchfab yükleme hatası!", true); },
        autostart: 1, ui_annotations: 1, ui_controls: 1
    });
</script>
</body>
</html>
