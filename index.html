<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tramvay – Sesli Deneyim</title>
<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #000;
    }

    /* 3D GÖRÜNTÜLEYİCİ */
    #viewer {
        width: 100%;
        height: 100%;
        border: none;
        display: block; /* Başlangıçta görünür, ama overlay üstünde olacak */
    }

    /* GİRİŞ EKRANI (Sorunu Çözen Kısım) */
    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95); /* Arkası hafif görünen siyah */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999; /* En üstte durması için */
        color: white;
        text-align: center;
    }

    /* BAŞLAT BUTONU TASARIMI */
    #startBtn {
        padding: 20px 50px;
        font-size: 24px;
        font-weight: bold;
        color: white;
        background: #e74c3c;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        transition: transform 0.2s, background 0.2s;
        margin-top: 20px;
    }

    #startBtn:hover {
        background: #c0392b;
        transform: scale(1.05); /* Üzerine gelince büyür */
    }

    #startBtn:active {
        transform: scale(0.95); /* Tıklayınca küçülür */
    }

    /* BİLGİ YAZILARI */
    h1 { margin-bottom: 10px; }
    p { color: #ccc; max-width: 600px; line-height: 1.5; }

    /* DEBUG KUTUSU (Sol Üst) */
    #debugLog {
        position: fixed; top: 10px; left: 10px; 
        background: rgba(0,0,0,0.7); color: #0f0; 
        padding: 10px; font-size: 12px; pointer-events: none; 
        z-index: 100000; font-family: monospace; max-width: 300px;
    }
    .err { color: #ff5555; font-weight: bold; }
</style>
</head>
<body>

<div id="overlay">
    <h1>Tramvay Deneyimi</h1>
    <p>Sesli deneyimi başlatmak için aşağıdaki butona tıklayın.<br>3D model üzerindeki numaralara tıklayarak sesleri duyabilirsiniz.</p>
    <button id="startBtn">DENEYİMİ BAŞLAT</button>
</div>

<div id="debugLog">Sistem Yükleniyor...<br></div>

<iframe src="" id="viewer" allow="autoplay; fullscreen; vr" allowvr allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>

<script>
    // === LOG YAZDIRMA ===
    function log(msg, isErr = false) {
        const d = document.getElementById("debugLog");
        d.innerHTML += (isErr ? "<span class='err'>[X] " : "[OK] ") + msg + (isErr ? "</span>" : "") + "<br>";
        console.log(msg);
    }

    // === 1. SES DOSYALARI LİSTESİ ===
    // Buradaki sıra Sketchfab'daki Annotation sırasıyla aynı olmalı (1, 2, 3...)
    // Not: Diziler 0'dan başlar. Annotation 1 -> sounds[0] olur.
    const fileNames = [
        "sounds/trafik.mp3",      
        "sounds/tramvay_ic.mp3",  
        "sounds/tramvay_ray.mp3", 
        "sounds/kapi.mp3",        
        "sounds/marti.mp3",       
        "sounds/nefes.mp3"        
    ];

    const sounds = fileNames.map(src => {
        const audio = new Audio(src);
        audio.loop = true;
        audio.preload = 'auto';
        audio.addEventListener('error', () => log("Dosya YOK: " + src, true));
        return audio;
    });

    let audioUnlocked = false;
    const overlay = document.getElementById("overlay");
    const btn = document.getElementById("startBtn");

    // === 2. BAŞLAT BUTONU OLAYI ===
    btn.addEventListener("click", function() {
        log("Butona basıldı.");
        
        // Ses motorunu "dürtüyoruz" (unlocking AudioContext)
        // Boş bir play/pause yaparak tarayıcıya "kullanıcı izin verdi" diyoruz.
        if(sounds[0]) {
            sounds[0].play().then(() => {
                sounds[0].pause();
                sounds[0].currentTime = 0;
                log("Ses kildi açıldı!");
                
                // Ekranı kaldır
                overlay.style.display = "none";
                audioUnlocked = true;
            }).catch(e => {
                log("Ses hatası: " + e.message, true);
                alert("Ses başlatılamadı! Dosya yollarını kontrol edin.");
            });
        }
    });

    function stopAll() {
        sounds.forEach(s => { s.pause(); s.currentTime = 0; });
    }

    // === 3. SKETCHFAB API ===
    const iframe = document.getElementById("viewer");
    const uid = "35d9707a712d4da1a88d1e4f82da8797"; 
    const client = new Sketchfab(iframe);

    client.init(uid, {
        success: function(api) {
            log("Sketchfab bağlandı.");
            api.start();
            api.addEventListener("viewerready", function() {
                log("Model yüklendi.");
                
                api.addEventListener("annotationFocus", function(index) {
                    if (!audioUnlocked) return; // Butona basılmadıysa çalma
                    
                    log("Tıklanan No: " + index);
                    stopAll();

                    if (sounds[index]) {
                        log("Çalıyor: " + fileNames[index]);
                        sounds[index].play().catch(e => log("Oynatma hatası: " + e, true));
                    } else {
                        log("Bu numara için ses yok.", true);
                    }
                });
            });
        },
        error: function() { log("Model yüklenemedi!", true); },
        autostart: 1, 
        ui_annotations: 1, 
        ui_controls: 1
    });
</script>

</body>
</html>
